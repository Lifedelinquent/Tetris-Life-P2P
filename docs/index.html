<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris Life Battle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- PeerJS for P2P connections -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>

<body>
    <canvas id="arcade-bg"></canvas>
    <canvas id="effects-canvas"
        style="position: fixed; top: 0; left: 0; pointer-events: none; z-index: 10; background: transparent;"></canvas>

    <!-- P2P Connection Screen (First Screen) -->
    <div id="p2p-screen" class="overlay">
        <div style="position: absolute; top: 20px; right: 20px;">
            <button id="music-toggle" class="arcade-btn-small">üéµ MUSIC: OFF</button>
        </div>
        <h1 class="neon-title">TetrisLife Battle</h1>
        <h2 style="color: #aaa; margin-bottom: 30px; font-size: 1rem;">P2P Edition - No Limits!</h2>

        <!-- Connection Options -->
        <div id="connection-options" class="user-selection">
            <button id="create-room-btn" class="arcade-btn"
                style="background: linear-gradient(135deg, #0DFF72, #0DC2FF); color: #000;">
                üè† CREATE ROOM
            </button>
            <button id="join-room-btn" class="arcade-btn"
                style="background: linear-gradient(135deg, #F538FF, #FF0D72); color: #000;">
                üîó JOIN ROOM
            </button>
            <button id="select-solo" class="arcade-btn" style="background: #4a90e2; margin-top: 20px;">
                Solo Mode
            </button>
        </div>

        <!-- Create Room (Hidden Initially) -->
        <div id="create-room-panel" class="user-selection hidden">
            <h3 style="color: #0DFF72; margin-bottom: 20px;">üì° CREATING ROOM...</h3>
            <div id="room-code-display" style="font-size: 4rem; color: #fff; letter-spacing: 15px; 
                text-shadow: 0 0 20px #0DFF72, 0 0 40px #0DFF72; margin: 30px 0;">
                ----
            </div>
            <p style="color: #aaa; font-size: 0.8rem; margin-bottom: 20px;">Share this code with your friend!</p>
            <div id="host-status" style="color: #FFD700; font-size: 0.9rem;">‚è≥ Waiting for opponent...</div>
            <button id="cancel-create-btn" class="arcade-btn"
                style="margin-top: 30px; border-color: #ff3333; color: #ff3333;">
                ‚úñ CANCEL
            </button>
        </div>

        <!-- Join Room (Hidden Initially) -->
        <div id="join-room-panel" class="user-selection hidden">
            <h3 style="color: #F538FF; margin-bottom: 20px;">üîó JOIN ROOM</h3>
            <p style="color: #aaa; font-size: 0.8rem; margin-bottom: 15px;">Enter the 4-character room code:</p>
            <input type="text" id="room-code-input" maxlength="4" style="font-family: 'Press Start 2P', cursive; font-size: 2.5rem; width: 200px; 
                text-align: center; letter-spacing: 10px; padding: 15px; background: #1a1a2e; 
                border: 3px solid #F538FF; color: #fff; text-transform: uppercase;" placeholder="----">
            <div id="join-error" style="color: #ff3333; font-size: 0.8rem; margin-top: 10px; min-height: 20px;"></div>
            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button id="confirm-join-btn" class="arcade-btn"
                    style="background: linear-gradient(135deg, #F538FF, #FF0D72); color: #000;">
                    ‚úì JOIN
                </button>
                <button id="cancel-join-btn" class="arcade-btn" style="border-color: #aaa; color: #aaa;">
                    ‚úñ BACK
                </button>
            </div>
        </div>

        <!-- Connected Panel (Shown after connection) -->
        <div id="connected-panel" class="user-selection hidden">
            <h3 style="color: #0DFF72; margin-bottom: 20px;">‚úì CONNECTED!</h3>
            <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin: 30px 0;">
                <div style="text-align: center;">
                    <img src="avatars/briannormal.png" alt="Lifedelinquent"
                        style="width: 100px; border-radius: 10px; border: 3px solid #0DFF72;">
                    <div style="color: #0DFF72; margin-top: 10px;">Lifedelinquent</div>
                    <div id="p1-ready-indicator" style="color: #FFD700; font-size: 0.8rem; margin-top: 5px;">
                        ‚è≥ Not Ready
                    </div>
                </div>
                <div style="font-size: 2rem; color: #fff;">VS</div>
                <div style="text-align: center;">
                    <img src="avatars/fernandonormal.png" alt="ChronoKoala"
                        style="width: 100px; border-radius: 10px; border: 3px solid #F538FF;">
                    <div style="color: #F538FF; margin-top: 10px;">ChronoKoala</div>
                    <div id="p2-ready-indicator" style="color: #FFD700; font-size: 0.8rem; margin-top: 5px;">
                        ‚è≥ Not Ready
                    </div>
                </div>
            </div>
            <div id="your-role" style="color: #aaa; font-size: 0.9rem; margin-bottom: 20px;">You are: ---</div>
            <button id="ready-btn" class="arcade-btn"
                style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; font-size: 1.2rem;">
                ‚úì READY!
            </button>
            <p style="color: #666; font-size: 0.7rem; margin-top: 15px;">Game starts when both players are ready</p>
        </div>
    </div>

    <!-- Old Login screen - keeping for rules reference, hidden by default now -->
    <div id="login-screen" class="overlay hidden">
        <div style="position: absolute; top: 20px; right: 20px;">
            <button id="music-toggle-old" class="arcade-btn-small">üéµ MUSIC: OFF</button>
        </div>
        <h1 class="neon-title">TetrisLife Battle:<br>
            <img id="lobby-life-avatar" src="avatars/brianangry.png" alt="Lifedelinquent"
                class="lobby-avatar">Lifedelinquent
            V
            Chronokoala<img id="lobby-chrono-avatar" src="avatars/fernandomad.png" alt="ChronoKoala"
                class="lobby-avatar">
        </h1>

        <div class="rules-container">
            <h3 style="color: #fff; margin-bottom: 15px; text-decoration: underline;">HOW TO PLAY</h3>

            <div class="rule-item">
                <span class="icon">üéÆ</span>
                <span>
                    <li><strong>Controls:</strong> Arrow Keys to Move/Rotate. Space to Drop.</li>
                    <li><strong>Hold:</strong> Press 'C' or 'Shift' to swap held piece.</li>
                    <li><strong>Pause:</strong> Press 'P' or 'Esc' to pause/unpause the game.</li>
                    <li><strong>Powerups:</strong> Spend cleared lines to use powerups! [S] [R] [E] keys.</li>
                </span>
            </div>
            <div class="rule-item">
                <span class="icon">üõ°Ô∏è</span>
                <span><strong>SHIELD [S] - 3 Lines:</strong> Blocks the next incoming garbage attack completely.</span>
            </div>
            <div class="rule-item">
                <span class="icon">‚ö°</span>
                <span><strong>LIGHTNING [R] - 6 Lines:</strong> Instantly get 3 long I-pieces in a row!</span>
            </div>
            <div class="rule-item">
                <span class="icon">üí£</span>
                <span><strong>BOMB [E] - 9 Lines:</strong> Sends a timer bomb to opponent. 10s to defuse or +2
                    garbage!</span>
            </div>
            <div class="rule-item">
                <span class="icon">üåà</span>
                <span><strong>COLOR BUSTER [Q] - 17 Lines:</strong> Removes ALL blocks of one color from your
                    board!</span>
            </div>
        </div>

        <div class="user-selection">
            <div class="player-select-row">
                <img id="btn-life-avatar" src="avatars/briannormal.png" alt="Lifedelinquent" class="btn-avatar hidden">
                <button id="select-lifedelinquent" class="arcade-btn">Lifedelinquent</button>
                <span id="life-ready-status" class="ready-indicator hidden">‚úì READY</span>
            </div>
            <div class="player-select-row">
                <img id="btn-chrono-avatar" src="avatars/fernandohappy.png" alt="ChronoKoala" class="btn-avatar hidden">
                <button id="select-chronokoala" class="arcade-btn">ChronoKoala</button>
                <span id="chrono-ready-status" class="ready-indicator hidden">‚úì READY</span>
            </div>
            <button id="start-battle-btn" class="arcade-btn start-btn" disabled>START BATTLE</button>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <!-- Pause Overlay -->
        <div id="pause-overlay" class="overlay hidden"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;">
            <div style="font-size: 5rem; color: #fff; text-shadow: 0 0 20px cyan, 0 0 40px cyan;">PAUSED</div>
            <div style="font-size: 1.5rem; color: #aaa; margin-top: 20px;">Press 'P' or 'Esc' to Resume</div>
        </div>
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="match-timer">
                <span>TIME:</span> <span id="timer">02:00</span>
            </div>
            <div class="match-score">
                <span id="p1-ko">0</span> - KO - <span id="p2-ko">0</span>
            </div>
            <div class="volume-control" style="display: flex; align-items: center; gap: 15px;">
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label for="music-slider" style="font-size: 0.6rem; color: #aaa;">MUSIC</label>
                        <input type="range" id="music-slider" min="0" max="1" step="0.05" value="0.5"
                            style="width: 70px;" onkeydown="if(event.key.startsWith('Arrow')) event.preventDefault()">
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label for="sfx-slider" style="font-size: 0.6rem; color: #aaa;">SFX</label>
                        <input type="range" id="sfx-slider" min="0" max="1" step="0.05" value="0.5" style="width: 70px;"
                            onkeydown="if(event.key.startsWith('Arrow')) event.preventDefault()">
                    </div>
                </div>
                <button id="ingame-music-toggle" class="arcade-btn-mini" tabindex="-1">üîä</button>
            </div>
        </div>

        <div class="split-screen-container">
            <!-- P1 (Left) -->
            <div class="player-split p1-split">
                <div class="player-header">
                    <h2 class="player-name p1-color">LIFEDELINQUENT</h2>
                    <div class="player-stats">
                        <span>WINS: <span id="p1-lifetime-wins">0</span></span>
                        <span>SCORE: <span id="p1-pb">0</span></span>
                    </div>
                    <div id="p1-combo-container"
                        style="width: 100px; height: 8px; background: #333; margin: 5px auto; display: none; border: 1px solid #555;">
                        <div id="p1-combo-fill"
                            style="height: 100%; width: 0%; background: linear-gradient(90deg, #0DC2FF, #FF0D72); transition: width 0.2s;">
                        </div>
                    </div>
                </div>

                <div class="board-area">
                    <div class="side-panel left">
                        <div class="hold-box">
                            <div class="label">HOLD</div>
                            <canvas id="p1-hold" width="100" height="100"></canvas>
                        </div>

                        <!-- Powerups (Icon Based) - Disabled until earned -->
                        <div class="power-ups" id="p1-powerups"
                            style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p1-shield-btn" disabled
                                    title="Shield - Block next attack">
                                    <img src="images/icon_shield.png" alt="Shield" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[S]</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p1-rush-btn" disabled title="Lightning - Get 3 I-pieces">
                                    <img src="images/icon_lightning.png" alt="Rush" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[R]</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p1-twin-btn" disabled
                                    title="Bomb - Mess up opponent's top">
                                    <img src="images/icon_bomb.png" alt="Bomb" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[E]</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p1-buster-btn" disabled
                                    title="Color Buster - Remove all blocks of one color">
                                    <img src="images/icon_buster.png" alt="Color Buster" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[Q]</span>
                            </div>
                        </div>
                        <!-- P1 Avatar (Brian/Lifedelinquent) - Left side for symmetry with Fernando -->
                        <div class="avatar-container" style="margin-top: 20px; text-align: center;">
                            <img id="p1-avatar" src="avatars/briannormal.png" alt="Lifedelinquent"
                                style="width: 120px; border-radius: 10px; border: 2px solid #0DFF72;">
                            <div class="lines-sent-box">
                                <span class="lines-sent-label">‚öîÔ∏è ATTACK</span>
                                <span id="p1-lines-sent" class="lines-sent-value">0</span>
                            </div>
                            <!-- Shield Status (Moved Here) -->
                            <div id="p1-shield-indicator" class="shield-indicator hidden">
                                <div class="shield-active-glow">Shield Active</div>
                                <span class="shield-emoji">üõ°Ô∏è</span>
                            </div>
                        </div>
                    </div>

                    <div class="main-board-container p1-border" style="position: relative;">
                        <div class="garbage-meter" id="p1-garbage-meter"></div>

                        <canvas id="p1-canvas" width="480" height="800"></canvas>
                    </div>

                    <div class="side-panel right">
                        <div class="next-box">
                            <div class="label">NEXT</div>
                            <canvas id="p1-next" width="100" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VS Divider -->
            <div class="vs-divider">
                <div class="vs-text">VS</div>
            </div>

            <!-- P2 (Right) -->
            <div class="player-split p2-split">
                <div class="player-header">
                    <h2 class="player-name p2-color">CHRONOKOALA</h2>
                    <div class="player-stats">
                        <span>WINS: <span id="p2-lifetime-wins">0</span></span>
                        <span>SCORE: <span id="p2-pb">0</span></span>
                    </div>
                    <div id="p2-combo-container"
                        style="width: 100px; height: 8px; background: #333; margin: 5px auto; display: none; border: 1px solid #555;">
                        <div id="p2-combo-fill"
                            style="height: 100%; width: 0%; background: linear-gradient(90deg, #0DC2FF, #FF0D72); transition: width 0.2s;">
                        </div>
                    </div>
                </div>

                <div class="board-area">
                    <div class="side-panel left">
                        <div class="hold-box">
                            <div class="label">HOLD</div>
                            <canvas id="p2-hold" width="100" height="100"></canvas>
                        </div>

                        <!-- Powerups (Mirrored for P2) - Same layout as P1 -->
                        <div class="power-ups" id="p2-powerups"
                            style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p2-shield-btn" disabled
                                    title="Shield - Block next attack">
                                    <img src="images/icon_shield.png" alt="Shield" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[S]</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p2-rush-btn" disabled title="Lightning - Get 3 I-pieces">
                                    <img src="images/icon_lightning.png" alt="Rush" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[R]</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p2-twin-btn" disabled
                                    title="Bomb - Mess up opponent's top">
                                    <img src="images/icon_bomb.png" alt="Bomb" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[E]</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="power-icon" id="p2-buster-btn" disabled
                                    title="Color Buster - Remove all blocks of one color">
                                    <img src="images/icon_buster.png" alt="Color Buster" class="power-img">
                                </button>
                                <span style="font-size: 0.7rem; color: #aaa;">[Q]</span>
                            </div>
                        </div>
                        <!-- P2 Avatar (Fernando/ChronoKoala) - Left side to match P1 -->
                        <div class="avatar-container" style="margin-top: 20px; text-align: center;">
                            <img id="p2-avatar" src="avatars/fernandonormal.png" alt="ChronoKoala"
                                style="width: 120px; border-radius: 10px; border: 2px solid #F538FF;">
                            <div class="lines-sent-box p2-theme">
                                <span class="lines-sent-label">‚öîÔ∏è ATTACK</span>
                                <span id="p2-lines-sent" class="lines-sent-value">0</span>
                            </div>
                            <!-- Shield Status (Moved Here) -->
                            <div id="p2-shield-indicator" class="shield-indicator hidden p2-theme">
                                <div class="shield-active-glow">Shield Active</div>
                                <span class="shield-emoji">üõ°Ô∏è</span>
                            </div>
                        </div>
                    </div>

                    <div class="main-board-container p2-border" style="position: relative;">
                        <div class="garbage-meter" id="p2-garbage-meter"></div>

                        <canvas id="p2-canvas" width="480" height="800"></canvas>
                    </div>

                    <div class="side-panel right">
                        <div class="next-box">
                            <div class="label">NEXT</div>
                            <canvas id="p2-next" width="100" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Powerup Tooltip (Absolute Centered or Fixed) -->
        <div id="powerup-tooltip" class="tooltip hidden">Test Description</div>
    </div>

    <div id="countdown-overlay" class="overlay hidden">
        <h1 id="countdown-text" class="neon-title" style="font-size: 8rem; animation: pulse 0.5s infinite;">3</h1>
    </div>

    <div id="game-over-screen" class="overlay hidden" style="z-index: 150;">
        <h2 id="winner-text" class="neon-title" style="margin-bottom: 30px;"></h2>
        <div style="display: flex; gap: 20px;">
            <button id="restart-btn" class="arcade-btn">PLAY AGAIN</button>
            <button id="quit-btn" class="arcade-btn"
                style="border-color: #ff3333; color: #ff3333; text-shadow: 0 0 5px #ff3333;">QUIT</button>
        </div>
    </div>

    <script>
        window.addEventListener('error', function (e) {
            console.error(e);
            // alert('Javascript Error: ' + e.message); 
        });
    </script>
    <script type="module" src="main.js?v=9"
        onerror="alert('Failed to load main.js module. Check console for CORS or Syntax errors.')"></script>
</body>

</html>